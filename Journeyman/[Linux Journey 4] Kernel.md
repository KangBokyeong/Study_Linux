# [Linux Journey 4] Kernel
## 1. Overview of the Kernel
- 커널은 운영체제의 핵심.
- Linux 운영 체제는 세 가지 다른 레벨의 추상화로 구성 될 수 있음.
- 하드웨어 (가장 기본적인 레벨)
  - CPU, 메모리, 하드디스크, 네트워킹 등이 포함
  - 실제 기계가 수행하는 작업을 계산하는 물리적 계층
- 프로세스 및 메모리 관리, 장치 통신, 시스템 호출 처리, 파일 시스템 설정 커널
  - 커널의 임무: 하드웨어와 대화애여 우리 프로세스가 원하는 것 수행
- 사용자 공간(익숙한 레벨)
  - 쉘, 실행하는 프로그램 그래픽 등이 포함.
- 커널에 초첨을 맞춰 복잡성을 배우게 됨.

## 2. Privilege Levels
- 커널 모드
  - 하드웨어에 대한 완전한 액세스 권한을 가지며 모든 것을 제어
  - 기본적으로 하드웨어와 관련된 작업, 디스크에서 데이터 읽기, 디스크에 데이터 쓰기, 네트워크 제어 작업 등을 수행하려면 이 모드로 수행
- 사용자 공간 모드
  - 사용자가 액세스 할 수있는 매우 적은 양의 안전한 메모리와 CPU가 있음.
- 이러한 다른 모드를 권한 레벨이라고 함.
- 종종 보로힝으로 설명됨.
  - 가장 안쪽에있는 링은 가장 높은 권한 레벨에 해당
  - x86 컴퓨터 아키텍처에는 두 가지 주요 레벨 또는 모드가 있음.
  - Ring#0
    - 사용자 모드 응용 프로그램이 실행되는 권한
    - 커널이 실행 되는 권한
    - 모든 시스템 명령어 실행 가능
    - 완전히 신뢰됨.
    
## 3. System Calls
- 사용자 공간 프로세스를 통해 커널이 우리를 위해 뭔가를 하도록 요청할 수있는 방법 제공
- 커널은 시스템 호출 API를 통해 특정 서비스를 사용할 수 있도록 함.
- 우리가 파일을 읽거나 쓰고, 메모리 사용량을 수정하고, 네트워크를 수정하는 것 등을 가능하게 함.
- 서비스의 양은 고정되어 있으므로 시스템 호출 추가 불가능
- 시스템은 이미 어떤 시스템 호가 존재하는지 표를 가지고 있고 각 시스템 호는 고유한 ID를 가지고 있음.
- 기본적으로 ls와 같은 프로그램을 호출할 때 이 프로그램 안에 있는 코드는 시스템 호출 래퍼(아직 실제 시스템 호출은 아님)를 포함
- system 번호를 찾아보고, 그것을 system ID에 기초한 테이블에서 찾고, 당신이 실행하고자 하는 기능 실행
- 완료되면 사용자 모드로 돌아가고 프로세스가 성공하거나 오류가 발생하면 상태 반환
- strace 명령으로 프로세스가 만드는 시스템 호출을 실제로 볼 수 있음. 
- strace 명령은 프로그램 실행 방법을 디버깅하는데 유용.
  > strace ls

## 4. Kernel Installation
- 커널 버전 확인 명령어
  > uname -r
  > 3.19.0-43-generic
    - 두 번째 행은 결과 예시
    - 시스템 정보 출력.
    - -r: 모든 커널 릴리스 버전 인쇄

- Linux 커널을 다른 방법으로 설치
- 소스 패키지를 다운로드하고 소스에서 컴파일하거나 패키지 관리 도구를 사용하여 설치 가능
- 예시
  > sudo apt install linux-generic-lts-vivid
  - 아래와 같이 버전 번호 지정 가능
  > sudo apt install 3.19.0-43-generic

- 업데이트 된 커널 버전을 원한다면 dist-upgrade 사용 시, 시스템의 모든 패키지 업그레이드
- 예시
  > sudo apt dist-upgrade

## 5. Kernel Location
- 새 커널을 설치하면 실제로 시스템에 몇 개의 파일을 추가함.
- 이 파일은 일반적으로 / boot 디렉토리에 추가됨.
- 서로 다른 버전에 대해 여러 개의 파일이 표시됨.
  - vmlinuz: 실제 리눅스 커널
  - initrd: 임시 파일 시스템으로 사용되며 커널을로드하기 전에 사용됨
  - System.map: 심볼 룩업 테이블
  - config: 커널 구성 설정, 자신의 커널을 컴파일하는 경우 로드할 수 있는 모듈 설정 가능
  
## 6. Kernel Modules
- 커널 자체는 단일 소프트웨어로서 새로운 유형의 키보드 지원을 추가할 때 커널 코드에 직접 이 코드를 입력하지 않음.
- 커널 모듈은 요청 시 커널에 로드되고 언로드될 수 있는 코드 조각
- 핵심 커널 코드에 실제로 추가되지 않고 커널의 기능을 확장 가능하게 해줌.
- 모듈을 추가할 수 있으며 시스템을 재부팅할 필요가 없음(대부분의 경우).

### 현재로드 된 모듈 목록보기
- 예시
  > lsmod

### 모듈 로드
- 예시
  > sudo modprobe bluetooth
    - Modprobe 로드는 모듈을 / lib / modules / (커널 버전) / kernel / drivers 에서 시도.
    - 커널 모듈은 종속성을 가질 수도 있음.
    - 모듈로드가 아직 로드되지 않은 경우, 모듈 종속성을 로드함.

### 모듈 제거
- 예시
  > sudo modprobe -r bluetooth

### 부팅 시 로드
- 시스템 부팅 시, 모듈 로드 가능
- modprobe 재부팅 시, 언로드
- etc/modprobe.d 디렉토리를 수정하고 다음과 같이 구성 파일을 추가한 예시
  > /etc/modprobe.d/peanutbutter.conf
  - 아래는 결과
  > options peanut_butter type=almond
    - peanut_butter라는 모듈이 있음.
    - type = almond에 커널 매개 변수를 추가하려면이 구성 파일을 사용하여 시작 시 로드 가능.
    - 커널 모듈에는 고유 한 커널 매개 변수가 있음.
    - 모듈에 대해 자세히 알아보려면 이 모듈을 읽어야 함.
 
### 부팅 시 로드 금지
- 설정 파일을 추가하여 부팅 시 모듈이 로드되지 않도록한 예시
  > /etc/modprobe.d/peanutbutter.conf
  - 아래는 결과
  > blacklist peanut_butter
